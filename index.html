<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMA é›™å‡ç·šå›æ¸¬ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-upload {
            border: 2px dashed #667eea;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-upload:hover {
            background: #f5f5f5;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 5px;
        }

        .chart-container {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .chart-canvas {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            cursor: crosshair;
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .legend-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .legend-item.hidden {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .legend-symbol {
            font-size: 1.2em;
        }

        .tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip-date {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        .tooltip-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            padding: 2px 0;
        }

        .tooltip-label {
            margin-right: 12px;
        }

        .tooltip-value {
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .view-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .view-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .view-tab:hover {
            background: #e0e0e0;
        }

        .view-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .detail-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="chartTooltip" class="tooltip"></div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å…«æ–¹ä¾†è²¡&MAå›ç­–ç³»çµ±</h1>
            <p>âœ¨ å®—æ—¨åˆ©æ»¾åˆ©å°æ‡‰å¥½é‹å…«æ–¹ä¾†</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('single')">å–®ä¸€ç­–ç•¥å›æ¸¬</button>
            <button class="tab" onclick="switchTab('optimize')">åƒæ•¸å„ªåŒ–æ¨¡å¼</button>
        </div>

        <div class="content">
            <!-- å–®ä¸€ç­–ç•¥å›æ¸¬ -->
            <div id="single" class="tab-content active">
                <h2>ğŸ¯ å–®ä¸€ç­–ç•¥å›æ¸¬</h2>
                <div class="info-box">
                    è¼¸å…¥çŸ­æœŸèˆ‡é•·æœŸå‡ç·šå¤©æ•¸ï¼Œç³»çµ±å°‡é‡å°é»ƒé‡‘äº¤å‰ï¼ˆè²·å…¥ï¼‰èˆ‡æ­»äº¡äº¤å‰ï¼ˆè³£å‡ºï¼‰çš„å›æ¸¬çµæœã€‚
                </div>

                <div class="form-group">
                    <label>ğŸ“ ä¸Šå‚³ CSV æª”æ¡ˆ</label>
                    <div class="file-upload" onclick="document.getElementById('csvFile1').click()">
                        <input type="file" id="csvFile1" accept=".csv" style="display:none" onchange="handleFileUpload(1)">
                        <p id="fileName1">é»æ“Šä¸Šå‚³æˆ–æ‹–æ”¾ CSV æª”æ¡ˆ</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>é¸æ“‡è‚¡ç¥¨ä»£ç¢¼</label>
                    <select id="stockSelect1">
                        <option value="">è«‹å…ˆä¸Šå‚³ CSV æª”æ¡ˆ</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>çŸ­æœŸå‡ç·šé¡å‹</label>
                        <select id="shortMAType">
                            <option value="SMA">SMA (ç°¡å–®ç§»å‹•å¹³å‡)</option>
                            <option value="EMA">EMA (æŒ‡æ•¸ç§»å‹•å¹³å‡)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>çŸ­æœŸå‡ç·šï¼ˆå¤©æ•¸ï¼‰</label>
                        <input type="number" id="shortMA" value="5" min="1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é•·æœŸå‡ç·šé¡å‹</label>
                        <select id="longMAType">
                            <option value="SMA">SMA (ç°¡å–®ç§»å‹•å¹³å‡)</option>
                            <option value="EMA">EMA (æŒ‡æ•¸ç§»å‹•å¹³å‡)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é•·æœŸå‡ç·šï¼ˆå¤©æ•¸ï¼‰</label>
                        <input type="number" id="longMA" value="20" min="1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥æœŸ</label>
                        <input type="text" id="startDate1" value="1/1/2024" placeholder="M/D/YYYY">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="text" id="endDate1" value="12/31/2024" placeholder="M/D/YYYY">
                    </div>
                </div>

                <div class="form-group">
                    <label>åˆå§‹è³‡é‡‘ ($)</label>
                    <input type="number" id="initialCash1" value="10000" min="1">
                </div>

                <button class="btn" onclick="runSingleBacktest()">é–‹å§‹å›æ¸¬</button>

                <div class="error" id="error1"></div>
                <div class="loading" id="loading1">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è¨ˆç®—ä¸­...</p>
                </div>
                <div class="results" id="results1"></div>
            </div>

            <!-- åƒæ•¸å„ªåŒ–æ¨¡å¼ -->
            <div id="optimize" class="tab-content">
                <h2>âš™ï¸ åƒæ•¸å„ªåŒ–æ¨¡å¼</h2>
                <div class="info-box">
                    ç³»çµ±å°‡æ¸¬è©¦æ‰€æœ‰å¯èƒ½çš„å‡ç·šçµ„åˆï¼Œæ‰¾å‡ºæœ€ä½³ç­–ç•¥åƒæ•¸ã€‚
                </div>

                <div class="form-group">
                    <label>ğŸ“ ä¸Šå‚³ CSV æª”æ¡ˆ</label>
                    <div class="file-upload" onclick="document.getElementById('csvFile2').click()">
                        <input type="file" id="csvFile2" accept=".csv" style="display:none" onchange="handleFileUpload(2)">
                        <p id="fileName2">é»æ“Šä¸Šå‚³æˆ–æ‹–æ”¾ CSV æª”æ¡ˆ</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>é¸æ“‡è‚¡ç¥¨ä»£ç¢¼</label>
                    <select id="stockSelect2">
                        <option value="">è«‹å…ˆä¸Šå‚³ CSV æª”æ¡ˆ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å‡ç·šé¡å‹</label>
                    <select id="maType">
                        <option value="SMA">SMA (ç°¡å–®ç§»å‹•å¹³å‡)</option>
                        <option value="EMA">EMA (æŒ‡æ•¸ç§»å‹•å¹³å‡)</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>æœ€å°å‡ç·šå¤©æ•¸</label>
                        <input type="number" id="minMA" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§å‡ç·šå¤©æ•¸</label>
                        <input type="number" id="maxMA" value="256" min="1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥æœŸ</label>
                        <input type="text" id="startDate2" value="1/1/2024" placeholder="M/D/YYYY">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="text" id="endDate2" value="12/31/2024" placeholder="M/D/YYYY">
                    </div>
                </div>

                <div class="form-group">
                    <label>åˆå§‹è³‡é‡‘ ($)</label>
                    <input type="number" id="initialCash2" value="10000" min="1">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é¡¯ç¤ºçµæœæ•¸é‡</label>
                        <select id="displayCount">
                            <option value="10">å‰ 10 å</option>
                            <option value="20">å‰ 20 å</option>
                            <option value="30" selected>å‰ 30 å</option>
                            <option value="50">å‰ 50 å</option>
                            <option value="100">å‰ 100 å</option>
                            <option value="custom">è‡ªè¨‚æ•¸é‡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è‡ªè¨‚æ•¸é‡ï¼ˆé¸æ“‡è‡ªè¨‚æ™‚ï¼‰</label>
                        <input type="number" id="customCount" value="30" min="1" disabled>
                    </div>
                </div>

                <button class="btn" onclick="runOptimization()">é–‹å§‹å„ªåŒ–</button>

                <div class="error" id="error2"></div>
                <div class="loading" id="loading2">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æ¸¬è©¦æ‰€æœ‰åƒæ•¸çµ„åˆ...</p>
                </div>
                <div class="results" id="results2"></div>
            </div>
        </div>
    </div>

    <script>
        let csvData1 = null;
        let csvData2 = null;
        let allOptimizationResults = [];
        let currentView = 'top';
        let chartState = {
            visible: { price: true, shortMA: true, longMA: true, trades: true },
            chartData: null,
            canvas: null,
            ctx: null,
            padding: null,
            chartWidth: 0,
            chartHeight: 0,
            minPrice: 0,
            maxPrice: 0,
            priceRange: 0
        };

        document.addEventListener('DOMContentLoaded', function() {
            const displayCountSelect = document.getElementById('displayCount');
            const customCountInput = document.getElementById('customCount');
            
            if (displayCountSelect) {
                displayCountSelect.addEventListener('change', function() {
                    customCountInput.disabled = (this.value !== 'custom');
                });
            }
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function handleFileUpload(mode) {
            const fileInput = document.getElementById(`csvFile${mode}`);
            const file = fileInput.files[0];
            
            if (!file) return;

            document.getElementById(`fileName${mode}`).textContent = `å·²é¸æ“‡ï¼š${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const stockSelect = document.getElementById(`stockSelect${mode}`);
                stockSelect.innerHTML = '<option value="">é¸æ“‡è‚¡ç¥¨ä»£ç¢¼</option>';
                
                headers.slice(1).forEach(header => {
                    if (header) {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        stockSelect.appendChild(option);
                    }
                });

                if (mode === 1) csvData1 = { headers, lines };
                else csvData2 = { headers, lines };
            };
            reader.readAsText(file);
        }

        function parseCSVData(csvData, stockSymbol) {
            const targetCol = csvData.headers.indexOf(stockSymbol);
            if (targetCol === -1) return null;

            const dates = [];
            const closes = [];

            for (let i = 1; i < csvData.lines.length; i++) {
                const values = csvData.lines[i].split(',');
                if (values.length > targetCol && values[0] && values[targetCol]) {
                    const date = values[0].trim();
                    const close = parseFloat(values[targetCol]);
                    if (date && !isNaN(close) && close > 0) {
                        dates.push(date);
                        closes.push(close);
                    }
                }
            }

            return { dates, closes };
        }

        function computeMA(closes, window, type = 'SMA') {
            if (type === 'SMA') {
                const ma = [];
                if (closes.length < window) return ma;

                let sum = 0;
                for (let i = 0; i < window; i++) {
                    sum += closes[i];
                }
                ma.push(sum / window);

                for (let i = window; i < closes.length; i++) {
                    sum += closes[i];
                    sum -= closes[i - window];
                    ma.push(sum / window);
                }
                return ma;
            } else if (type === 'EMA') {
                const ma = [];
                if (closes.length < window) return ma;

                const alpha = 2.0 / (window + 1);
                let sum = 0;
                for (let i = 0; i < window; i++) {
                    sum += closes[i];
                }
                ma.push(sum / window);

                for (let i = window; i < closes.length; i++) {
                    ma.push(alpha * closes[i] + (1 - alpha) * ma[ma.length - 1]);
                }
                return ma;
            }
        }

        function backtest(dates, closes, shortMA_window, longMA_window, initialCash, outputStartIdx, endIdx, shortMAType = 'SMA', longMAType = 'SMA') {
            const shortMA = computeMA(closes, shortMA_window, shortMAType);
            const longMA = computeMA(closes, longMA_window, longMAType);

            let cash = initialCash;
            let shares = 0;
            const trades = [];
            let tradeCount = 0;

            for (let i = outputStartIdx; i <= endIdx; i++) {
                const shortMAIdx = i - (shortMA_window - 1);
                const longMAIdx = i - (longMA_window - 1);

                // å¿…é¡»ç¡®ä¿æ—¢æœ‰å½“å¤© MAï¼Œä¹Ÿæœ‰å‰ä¸€å¤© MAï¼ˆshortMAIdx >= 1, longMAIdx >= 1ï¼‰
                // ä¹Ÿè¦è·³è¿‡ç¬¬ä¸€ä¸ªè¾“å‡ºæ—¥æœŸï¼ˆi == outputStartIdxï¼‰ç¡®ä¿æœ‰å‰ä¸€ä¸ªå‚è€ƒç‚¹
                if (shortMAIdx < 1 || longMAIdx < 1 || i === outputStartIdx ||
                    shortMAIdx >= shortMA.length || longMAIdx >= longMA.length) {
                    continue;
                }

                const prevShortMAIdx = shortMAIdx - 1;
                const prevLongMAIdx = longMAIdx - 1;

                const currShortMA = shortMA[shortMAIdx];
                const currLongMA = longMA[longMAIdx];
                const prevShortMA = shortMA[prevShortMAIdx];
                const prevLongMA = longMA[prevLongMAIdx];
                const currPrice = closes[i];

                // æ£€æŸ¥æ‰€æœ‰ MA å€¼éƒ½æœ‰æ•ˆï¼ˆä¸ä¸º nullï¼‰
                if (prevShortMA === null || prevShortMA === undefined || 
                    prevLongMA === null || prevLongMA === undefined ||
                    currShortMA === null || currShortMA === undefined ||
                    currLongMA === null || currLongMA === undefined) {
                    continue;
                }

                // é»„é‡‘äº¤å‰ï¼šå‰ä¸€å¤©çŸ­çº¿ <= é•¿çº¿ï¼Œä»Šå¤©çŸ­çº¿ > é•¿çº¿ï¼Œä¸”å¿…é¡»æ²¡æœ‰æŒè‚¡
                if (prevShortMA <= prevLongMA && currShortMA > currLongMA && shares === 0) {
                    shares = Math.floor(cash / currPrice);
                    const cost = shares * currPrice;
                    cash -= cost;
                    tradeCount++;

                    trades.push({
                        date: dates[i],
                        action: 'è²·å…¥',
                        price: currPrice,
                        shares: shares,
                        cashAfter: cash
                    });
                }
                // æ­»äº¡äº¤å‰ï¼šå‰ä¸€å¤©çŸ­çº¿ >= é•¿çº¿ï¼Œä»Šå¤©çŸ­çº¿ < é•¿çº¿ï¼Œä¸”å¿…é¡»å·²æœ‰æŒè‚¡
                else if (prevShortMA >= prevLongMA && currShortMA < currLongMA && shares > 0) {
                    const revenue = shares * currPrice;
                    cash += revenue;

                    trades.push({
                        date: dates[i],
                        action: 'è³£å‡º',
                        price: currPrice,
                        shares: shares,
                        cashAfter: cash
                    });

                    shares = 0;
                    tradeCount++;
                }
            }

            let finalValue = cash;
            if (shares > 0) {
                finalValue += shares * closes[endIdx];
                trades.push({
                    date: dates[endIdx],
                    action: 'æœŸæœ«è³£å‡º',
                    price: closes[endIdx],
                    shares: shares,
                    cashAfter: finalValue
                });
                tradeCount++;
            }

            const returnRate = ((finalValue - initialCash) / initialCash) * 100;

            return {
                shortMA: shortMA_window,
                longMA: longMA_window,
                shortMAType: shortMAType,
                longMAType: longMAType,
                finalValue,
                returnRate,
                tradeCount,
                trades,
                shortMAData: shortMA,
                longMAData: longMA
            };
        }

        function showError(mode, message) {
            const errorDiv = document.getElementById(`error${mode}`);
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function runSingleBacktest() {
            const stockSymbol = document.getElementById('stockSelect1').value;
            const shortMA = parseInt(document.getElementById('shortMA').value);
            const longMA = parseInt(document.getElementById('longMA').value);
            const shortMAType = document.getElementById('shortMAType').value;
            const longMAType = document.getElementById('longMAType').value;
            const startDate = document.getElementById('startDate1').value;
            const endDate = document.getElementById('endDate1').value;
            const initialCash = parseFloat(document.getElementById('initialCash1').value);

            if (!csvData1) {
                showError(1, 'è«‹å…ˆä¸Šå‚³ CSV æª”æ¡ˆ');
                return;
            }

            if (!stockSymbol) {
                showError(1, 'è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼');
                return;
            }

            document.getElementById('loading1').classList.add('show');
            document.getElementById('results1').classList.remove('show');

            setTimeout(() => {
                const data = parseCSVData(csvData1, stockSymbol);
                if (!data) {
                    showError(1, 'ç„¡æ³•è§£æè‚¡ç¥¨è³‡æ–™');
                    document.getElementById('loading1').classList.remove('show');
                    return;
                }

                let startIdx = data.dates.indexOf(startDate);
                let endIdx = data.dates.indexOf(endDate);

                if (startIdx === -1) {
                    const startDateObj = new Date(startDate);
                    for (let i = 0; i < data.dates.length; i++) {
                        const currentDate = new Date(data.dates[i]);
                        if (currentDate >= startDateObj) {
                            startIdx = i;
                            break;
                        }
                    }
                    if (startIdx === -1) {
                        showError(1, 'æ‰¾ä¸åˆ°é–‹å§‹æ—¥æœŸä¹‹å¾Œçš„äº¤æ˜“è³‡æ–™');
                        document.getElementById('loading1').classList.remove('show');
                        return;
                    }
                }

                if (endIdx === -1) {
                    const endDateObj = new Date(endDate);
                    for (let i = data.dates.length - 1; i >= 0; i--) {
                        const currentDate = new Date(data.dates[i]);
                        if (currentDate <= endDateObj) {
                            endIdx = i;
                            break;
                        }
                    }
                    if (endIdx === -1) {
                        showError(1, 'æ‰¾ä¸åˆ°çµæŸæ—¥æœŸä¹‹å‰çš„äº¤æ˜“è³‡æ–™');
                        document.getElementById('loading1').classList.remove('show');
                        return;
                    }
                }

                if (startIdx >= endIdx) {
                    showError(1, 'é–‹å§‹æ—¥æœŸå¿…é ˆæ—©æ–¼çµæŸæ—¥æœŸ');
                    document.getElementById('loading1').classList.remove('show');
                    return;
                }

                // å¾€å‰æ“´å±•æ•¸æ“šä»¥è¨ˆç®—åˆå§‹ MA å€¼ï¼ˆæŒ‰ç…§ C++ é‚è¼¯ï¼‰
                const longerPeriod = Math.max(shortMA, longMA);
                const extraDays = longerPeriod - 1;
                const dataStartIdx = Math.max(0, startIdx - extraDays);
                const outputStartIdx = startIdx - dataStartIdx;

                // æº–å‚™æ“´å±•å¾Œçš„æ•¸æ“š
                const expandedDates = data.dates.slice(dataStartIdx, endIdx + 1);
                const expandedCloses = data.closes.slice(dataStartIdx, endIdx + 1);

                const result = backtest(expandedDates, expandedCloses, shortMA, longMA, initialCash, outputStartIdx, expandedDates.length - 1, shortMAType, longMAType);

                // è¿”å›å°æ˜ è‡³åŸå§‹ startIdx çš„å›æ¸¬çµæœ
                displaySingleResult(result, initialCash, stockSymbol, data, startIdx, endIdx);
                document.getElementById('loading1').classList.remove('show');
            }, 100);
        }

        function displaySingleResult(result, initialCash, stockSymbol, data, startIdx, endIdx) {
            const resultsDiv = document.getElementById('results1');
            
            const chartDates = data.dates.slice(startIdx, endIdx + 1);
            const chartPrices = data.closes.slice(startIdx, endIdx + 1);
            const chartShortMA = [];
            const chartLongMA = [];

            for (let i = startIdx; i <= endIdx; i++) {
                const shortIdx = i - (result.shortMA - 1);
                const longIdx = i - (result.longMA - 1);
                chartShortMA.push(shortIdx >= 0 && shortIdx < result.shortMAData.length ? result.shortMAData[shortIdx] : null);
                chartLongMA.push(longIdx >= 0 && longIdx < result.longMAData.length ? result.longMAData[longIdx] : null);
            }

            chartState.visible = { price: true, shortMA: true, longMA: true, buy: true, sell: true, end: true };

            const shortMALabel = result.shortMAType === 'EMA' ? 'EMA' : 'SMA';
            const longMALabel = result.longMAType === 'EMA' ? 'EMA' : 'SMA';

            let html = `
                <div class="result-card">
                    <h3>ğŸ¯ å›æ¸¬çµæœ - ${stockSymbol}</h3>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">çŸ­æœŸå‡ç·š</div>
                            <div class="stat-value">${result.shortMA} å¤© (${shortMALabel})</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">é•·æœŸå‡ç·š</div>
                            <div class="stat-value">${result.longMA} å¤© (${longMALabel})</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åˆå§‹è³‡é‡‘</div>
                            <div class="stat-value">$${initialCash.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æœ€çµ‚è³‡ç”¢</div>
                            <div class="stat-value">$${result.finalValue.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å ±é…¬ç‡</div>
                            <div class="stat-value">${result.returnRate.toFixed(2)}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">äº¤æ˜“æ¬¡æ•¸</div>
                            <div class="stat-value">${result.tradeCount}</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h4>åƒ¹æ ¼èˆ‡ç§»å‹•å¹³å‡ç·šåœ–è¡¨</h4>
                    <div class="legend" id="chartLegend">
                        <div class="legend-item" data-series="price" onclick="toggleSeries('price')">
                            <span style="color: #666; font-weight: bold;">â”â”</span>
                            <span>æ”¶ç›¤åƒ¹</span>
                        </div>
                        <div class="legend-item" data-series="shortMA" onclick="toggleSeries('shortMA')">
                            <span style="color: #ff9800; font-weight bold;">â”â”</span>
                            <span>çŸ­æœŸå‡ç·š</span>
                        </div>
                        <div class="legend-item" data-series="longMA" onclick="toggleSeries('longMA')">
                            <span style="color: #4caf50; font-weight: bold;">â”â”</span>
                            <span>é•·æœŸå‡ç·š</span>
                        </div>
                        <div class="legend-item" data-series="buy" onclick="toggleSeries('buy')">
                            <span style="color: #4caf50;">â–²</span> <span>é»ƒé‡‘äº¤å‰</span>
                        </div>
                        <div class="legend-item" data-series="sell" onclick="toggleSeries('sell')">
                            <span style="color: #f44336;">â–¼</span> <span>æ­»äº¡äº¤å‰</span>
                        </div>
                        <div class="legend-item" data-series="end" onclick="toggleSeries('end')">
                            <span style="color: #000000;">â– </span> <span>æœŸæœ«å¹³å€‰</span>
                        </div>
                    </div>
                    <canvas id="mainChart" class="chart-canvas"></canvas>
                </div>

                <div class="detail-section">
                    <h4>ğŸ“ äº¤æ˜“æ˜ç´°</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å‹•ä½œ</th>
                                    <th>åƒ¹æ ¼</th>
                                    <th>æŒè‚¡æ•¸é‡</th>
                                    <th>è³‡ç”¢é¤˜é¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.trades.map(t => `
                                    <tr>
                                        <td>${t.date}</td>
                                        <td style="color: ${t.action.includes('è²·') ? '#e91e63' : '#2e7d32'}; font-weight: bold;">${t.action}</td>
                                        <td>$${t.price.toFixed(2)}</td>
                                        <td>${t.shares}</td>
                                        <td>$${t.cashAfter.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');

            // åˆå§‹åŒ–åœ–è¡¨ç¹ªè£½
            setTimeout(() => {
                initChart(chartDates, chartPrices, chartShortMA, chartLongMA, result.trades);
            }, 0);
        }

        // --- åœ–è¡¨æ ¸å¿ƒç¹ªè£½èˆ‡äº’å‹•é‚è¼¯ ---

        function initChart(dates, prices, shortMA, longMA, trades, canvasId = 'mainChart') {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            // è™•ç†é«˜æ¸…è¢å¹•æ¨¡ç³Šå•é¡Œ
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = 400 * dpr;
            ctx.scale(dpr, dpr);

            chartState.canvas = canvas;
            chartState.ctx = ctx;
            chartState.chartData = { dates, prices, shortMA, longMA, trades };
            chartState.padding = { top: 40, right: 30, bottom: 80, left: 60 };
            
            draw();

            // ç¶å®šæ»‘é¼ ç§»å‹•äº‹ä»¶ (é¡¯ç¤º Tooltip)
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseleave', () => {
                document.getElementById('chartTooltip').style.display = 'none';
            });
        }

        function draw() {
            const { ctx, canvas, chartData, padding, visible } = chartState;
            const width = canvas.width / (window.devicePixelRatio || 1);
            const height = canvas.height / (window.devicePixelRatio || 1);
            
            ctx.clearRect(0, 0, width, height);

            // è¨ˆç®—æ•¸å€¼ç¯„åœ
            const allVals = [];
            if (visible.price) allVals.push(...chartData.prices);
            if (visible.shortMA) allVals.push(...chartData.shortMA.filter(v => v !== null));
            if (visible.longMA) allVals.push(...chartData.longMA.filter(v => v !== null));

            const minP = Math.min(...allVals) * 0.98;
            const maxP = Math.max(...allVals) * 1.02;
            
            chartState.minPrice = minP;
            chartState.maxPrice = maxP;
            chartState.priceRange = maxP - minP;
            chartState.chartWidth = width - padding.left - padding.right;
            chartState.chartHeight = height - padding.top - padding.bottom;

            const getX = (i) => padding.left + (i / (chartData.dates.length - 1)) * chartState.chartWidth;
            const getY = (v) => padding.top + chartState.chartHeight - ((v - minP) / chartState.priceRange) * chartState.chartHeight;

            // 1. ç¹ªè£½åº§æ¨™è»¸èˆ‡èƒŒæ™¯æ ¼ç·š
            ctx.strokeStyle = '#f0f0f0';
            ctx.beginPath();
            for(let i=0; i<=5; i++) {
                const y = padding.top + (i / 5) * chartState.chartHeight;
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartState.chartWidth, y);
                ctx.fillStyle = '#999';
                ctx.font = '12px Arial';
                ctx.fillText((maxP - (i/5)*chartState.priceRange).toFixed(1), padding.left - 45, y + 4);
            }
            ctx.stroke();

            // 2. ç¹ªè£½æ—¥æœŸæ¨™ç±¤ (æ—‹è½‰ 45 åº¦ï¼Œå‹•æ…‹èª¿æ•´å¯†åº¦)
            ctx.fillStyle = '#666';
            ctx.font = '11px Arial';
            
            // å‹•æ…‹è¨ˆç®—æ—¥æœŸæ­¥é€²ï¼šæ ¹æ“šåœ–è¡¨å¯¬åº¦å’Œæ—¥æœŸå­—ç¬¦ä¸²é•·åº¦
            const avgDateLength = chartData.dates.reduce((sum, d) => sum + d.length, 0) / chartData.dates.length;
            const charWidth = 6.5; // å¹³å‡å­—ç¬¦å¯¬åº¦ï¼ˆåƒç´ ï¼‰
            const labelWidth = avgDateLength * charWidth; // æ¯å€‹æ¨™ç±¤çš„å¯¬åº¦
            const minLabelSpacing = labelWidth * 1.2; // æ¨™ç±¤ä¹‹é–“æœ€å°‘é–“è·ï¼ˆè€ƒæ…®æ—‹è½‰ 45 åº¦ï¼‰
            const maxLabels = Math.max(8, Math.floor(chartState.chartWidth / minLabelSpacing));
            const dateStep = Math.max(1, Math.ceil(chartData.dates.length / maxLabels));
            
            for(let i=0; i<chartData.dates.length; i+=dateStep) {
                const x = getX(i);
                ctx.save();
                ctx.translate(x, padding.top + chartState.chartHeight + 15);
                ctx.rotate(Math.PI / 4);
                ctx.fillText(chartData.dates[i], 0, 0);
                ctx.restore();
            }

            // 3. ç¹ªè£½æ•¸æ“šç·šæ¢
            if (visible.price) drawDataLine(chartData.prices, '#666', 2);
            if (visible.shortMA) drawDataLine(chartData.shortMA, '#ff9800', 1.5);
            if (visible.longMA) drawDataLine(chartData.longMA, '#4caf50', 1.5);

            // 4. ç¹ªè£½äº¤æ˜“é» (è²·å…¥/è³£å‡º)
            chartData.trades.forEach(t => {
                const idx = chartData.dates.indexOf(t.date);
                if (idx !== -1) {
                    const x = getX(idx);
                    const y = getY(t.price);
                    ctx.lineWidth = 1;

                    if (t.action === 'è²·å…¥' && visible.buy) {
                        // ç¶ è‰²å‘ä¸Šä¸‰è§’å½¢ (â–²)
                        ctx.fillStyle = '#4caf50';
                        ctx.beginPath();
                        ctx.moveTo(x, y - 10);
                        ctx.lineTo(x - 7, y + 5);
                        ctx.lineTo(x + 7, y + 5);
                        ctx.closePath();
                        ctx.fill();
                    } else if (t.action === 'è³£å‡º' && visible.sell) {
                        // ç´…è‰²å‘ä¸‹ä¸‰è§’å½¢ (â–¼)
                        ctx.fillStyle = '#f44336';
                        ctx.beginPath();
                        ctx.moveTo(x, y + 10);
                        ctx.lineTo(x - 7, y - 5);
                        ctx.lineTo(x + 7, y - 5);
                        ctx.closePath();
                        ctx.fill();
                    } else if (t.action === 'æœŸæœ«è³£å‡º' && visible.end) {
                        // é»‘è‰²æ­£æ–¹å½¢ (â– )
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(x - 5, y - 5, 10, 10);
                    }
                }
            });
        }

        function drawDataLine(data, color, lineWidth) {
            const { ctx, chartData } = chartState;
            const getX = (i) => chartState.padding.left + (i / (chartData.dates.length - 1)) * chartState.chartWidth;
            const getY = (v) => chartState.padding.top + chartState.chartHeight - ((v - chartState.minPrice) / chartState.priceRange) * chartState.chartHeight;

            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            let first = true;
            for(let i=0; i<data.length; i++) {
                if (data[i] === null) continue;
                if (first) {
                    ctx.moveTo(getX(i), getY(data[i]));
                    first = false;
                } else {
                    ctx.lineTo(getX(i), getY(data[i]));
                }
            }
            ctx.stroke();
        }

        function toggleSeries(series) {
            chartState.visible[series] = !chartState.visible[series];
            const legendItem = document.querySelector(`.legend-item[data-series="${series}"]`);
            legendItem.classList.toggle('hidden');
            draw(); // é‡æ–°æ¸²æŸ“
        }

        function handleMouseMove(e) {
            const rect = chartState.canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const { padding, chartWidth, chartData } = chartState;
            
            if (mouseX < padding.left || mouseX > padding.left + chartWidth) return;

            // è¨ˆç®—æœ€æ¥è¿‘çš„æ•¸æ“šç´¢å¼•
            const idx = Math.round(((mouseX - padding.left) / chartWidth) * (chartData.dates.length - 1));
            const tooltip = document.getElementById('chartTooltip');
            
            let html = `<div class="tooltip-date">${chartData.dates[idx]}</div>`;
            html += `<div class="tooltip-item"><span>åƒ¹æ ¼:</span> <span class="tooltip-value">${chartData.prices[idx].toFixed(2)}</span></div>`;
            
            if (chartData.shortMA[idx]) {
                html += `<div class="tooltip-item" style="color:#ff9800"><span>çŸ­å‡:</span> <span class="tooltip-value">${chartData.shortMA[idx].toFixed(2)}</span></div>`;
            }
            if (chartData.longMA[idx]) {
                html += `<div class="tooltip-item" style="color:#4caf50"><span>é•·å‡:</span> <span class="tooltip-value">${chartData.longMA[idx].toFixed(2)}</span></div>`;
            }

            tooltip.innerHTML = html;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
        }

        // --- å„ªåŒ–æ¨¡å¼é‚è¼¯ ---

         function displayOptimizationResults(results, initialCash, stockSymbol) {
            const resultsDiv = document.getElementById('results2');
            const best = results[0];
            const worst = results[results.length - 1];
            
            // å–å¾—é¡¯ç¤ºæ•¸é‡
            const displayCountSelect = document.getElementById('displayCount').value;
            let displayCount;
            if (displayCountSelect === 'custom') {
                displayCount = parseInt(document.getElementById('customCount').value);
            } else {
                displayCount = parseInt(displayCountSelect);
            }
            displayCount = Math.min(displayCount, results.length);
            
            let html = `
                <div class="result-card">
                    <h3>ğŸ† æœ€ä½³ç­–ç•¥ - ${stockSymbol}</h3>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">çŸ­æœŸå‡ç·š</div>
                            <div class="stat-value">${best.shortMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">é•·æœŸå‡ç·š</div>
                            <div class="stat-value">${best.longMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åˆå§‹è³‡é‡‘</div>
                            <div class="stat-value">${initialCash.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æœ€çµ‚è³‡ç”¢</div>
                            <div class="stat-value">${best.finalValue.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å ±é…¬ç‡</div>
                            <div class="stat-value">${best.returnRate.toFixed(2)}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">äº¤æ˜“æ¬¡æ•¸</div>
                            <div class="stat-value">${best.tradeCount}</div>
                        </div>
                    </div>
                </div>

                <div class="result-card" style="background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);">
                    <h3>ğŸ’” æœ€å·®ç­–ç•¥ - ${stockSymbol}</h3>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">çŸ­æœŸå‡ç·š</div>
                            <div class="stat-value">${worst.shortMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">é•·æœŸå‡ç·š</div>
                            <div class="stat-value">${worst.longMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åˆå§‹è³‡é‡‘</div>
                            <div class="stat-value">${initialCash.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æœ€çµ‚è³‡ç”¢</div>
                            <div class="stat-value">${worst.finalValue.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å ±é…¬ç‡</div>
                            <div class="stat-value">${worst.returnRate.toFixed(2)}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">äº¤æ˜“æ¬¡æ•¸</div>
                            <div class="stat-value">${worst.tradeCount}</div>
                        </div>
                    </div>
                </div>

                <div class="view-tabs">
                    <button class="view-tab ${currentView === 'top' ? 'active' : ''}" onclick="switchResultView('top')">
                        ğŸ“ˆ å‰ ${displayCount} å
                    </button>
                    <button class="view-tab ${currentView === 'bottom' ? 'active' : ''}" onclick="switchResultView('bottom')">
                        ğŸ“‰ å€’æ•¸ ${displayCount} å
                    </button>
                    <button class="view-tab ${currentView === 'all' ? 'active' : ''}" onclick="switchResultView('all')">
                        ğŸ“‹ å…¨éƒ¨çµæœ (${results.length})
                    </button>
                </div>
            `;

            // æ±ºå®šè¦é¡¯ç¤ºå“ªäº›çµæœ
            let displayResults = [];
            let title = '';
            
            if (currentView === 'top') {
                displayResults = results.slice(0, displayCount);
                title = `ğŸ“Š å‰ ${displayCount} åæœ€ä½³ç­–ç•¥`;
            } else if (currentView === 'bottom') {
                displayResults = results.slice(-displayCount).reverse();
                title = `ğŸ“Š å€’æ•¸ ${displayCount} åç­–ç•¥`;
            } else {
                displayResults = results;
                title = `ğŸ“Š å…¨éƒ¨ç­–ç•¥çµæœ (å…± ${results.length} çµ„)`;
            }

            html += `
                <h3>${title}</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>çŸ­æœŸMA</th>
                                <th>é•·æœŸMA</th>
                                <th>æœ€çµ‚è³‡ç”¢</th>
                                <th>å ±é…¬ç‡</th>
                                <th>äº¤æ˜“æ¬¡æ•¸</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            displayResults.forEach((r, index) => {
                let rank;
                if (currentView === 'bottom') {
                    rank = results.length - displayCount + index + 1;
                } else {
                    rank = results.indexOf(r) + 1;
                }
                
                html += `
                <tr style="cursor: pointer;" onclick="showDetailedResult(${r.shortMA}, ${r.longMA})">
                    <td>${rank}</td>
                    <td>${r.shortMA}</td>
                    <td>${r.longMA}</td>
                    <td>$${r.finalValue.toFixed(2)}</td>
                    <td>${r.returnRate.toFixed(2)}%</td>
                    <td>${r.tradeCount}</td>
                </tr>
            `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }
        function showDetailedResult(shortMADays, longMADays) {
            const stockSymbol = document.getElementById('stockSelect2').value;
            const initialCash = parseFloat(document.getElementById('initialCash2').value);
            const startDate = document.getElementById('startDate2').value;
            const endDate = document.getElementById('endDate2').value;

            const data = parseCSVData(csvData2, stockSymbol);
            if (!data) {
                showError(2, 'ç„¡æ³•è§£æè‚¡ç¥¨è³‡æ–™');
                return;
            }

            let startIdx = data.dates.indexOf(startDate);
            let endIdx = data.dates.indexOf(endDate);

            // å¦‚æœæ‰¾ä¸åˆ°é–‹å§‹æ—¥æœŸï¼Œå¾€å¾Œæ‰¾ç¬¬ä¸€å€‹äº¤æ˜“æ—¥
            if (startIdx === -1) {
                const startDateObj = new Date(startDate);
                for (let i = 0; i < data.dates.length; i++) {
                    const currentDate = new Date(data.dates[i]);
                    if (currentDate >= startDateObj) {
                        startIdx = i;
                        break;
                    }
                }
                if (startIdx === -1) startIdx = 0;
            }

            // å¦‚æœæ‰¾ä¸åˆ°çµæŸæ—¥æœŸï¼Œå¾€å‰æ‰¾æœ€å¾Œä¸€å€‹äº¤æ˜“æ—¥
            if (endIdx === -1) {
                const endDateObj = new Date(endDate);
                for (let i = data.dates.length - 1; i >= 0; i--) {
                    const currentDate = new Date(data.dates[i]);
                    if (currentDate <= endDateObj) {
                        endIdx = i;
                        break;
                    }
                }
                if (endIdx === -1) endIdx = data.dates.length - 1;
            }

            // å¾€å‰æ“´å±•æ•¸æ“šä»¥è¨ˆç®—åˆå§‹ MA å€¼ï¼ˆæŒ‰ç…§ C++ é‚è¼¯ï¼‰
            const longerPeriod = Math.max(shortMADays, longMADays);
            const extraDays = longerPeriod - 1;
            const dataStartIdx = Math.max(0, startIdx - extraDays);
            const outputStartIdx = startIdx - dataStartIdx;

            // æº–å‚™æ“´å±•å¾Œçš„æ•¸æ“š
            const expandedDates = data.dates.slice(dataStartIdx, endIdx + 1);
            const expandedCloses = data.closes.slice(dataStartIdx, endIdx + 1);

            // é‡æ–°åŸ·è¡Œå›æ¸¬ä»¥ç²å–å®Œæ•´äº¤æ˜“è¨˜éŒ„
            const result = backtest(expandedDates, expandedCloses, shortMADays, longMADays, initialCash, outputStartIdx, expandedDates.length - 1, allOptimizationResults[0]?.shortMAType || 'SMA', allOptimizationResults[0]?.longMAType || 'SMA');

            // è¨ˆç®—ç§»å‹•å¹³å‡ç·š
            const shortMA = computeMA(expandedCloses, shortMADays, result.shortMAType);
            const longMA = computeMA(expandedCloses, longMADays, result.longMAType);

            // æº–å‚™åœ–è¡¨æ•¸æ“š
            const chartDates = expandedDates.slice(outputStartIdx);
            const chartPrices = expandedCloses.slice(outputStartIdx);
            const chartShortMA = [];
            const chartLongMA = [];

            for (let i = outputStartIdx; i < expandedDates.length; i++) {
                const shortIdx = i - (shortMADays - 1);
                const longIdx = i - (longMADays - 1);
                chartShortMA.push(shortIdx >= 0 && shortIdx < shortMA.length ? shortMA[shortIdx] : null);
                chartLongMA.push(longIdx >= 0 && longIdx < longMA.length ? longMA[longIdx] : null);
            }

            // å‰µå»ºè©³ç´°çµæœè¦–åœ–
            let html = `
                <div class="detail-section">
                    <h3>ğŸ“ˆ ç­–ç•¥è©³ç´°åˆ†æ - ${stockSymbol}</h3>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">çŸ­æœŸå‡ç·š</div>
                            <div class="stat-value">${result.shortMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">é•·æœŸå‡ç·š</div>
                            <div class="stat-value">${result.longMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åˆå§‹è³‡é‡‘</div>
                            <div class="stat-value">$${initialCash.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æœ€çµ‚è³‡ç”¢</div>
                            <div class="stat-value">$${result.finalValue.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å ±é…¬ç‡</div>
                            <div class="stat-value">${result.returnRate.toFixed(2)}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">äº¤æ˜“æ¬¡æ•¸</div>
                            <div class="stat-value">${result.tradeCount}</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h4>åƒ¹æ ¼èˆ‡ç§»å‹•å¹³å‡ç·šåœ–è¡¨</h4>
                        <div class="legend">
                            <div class="legend-item" data-series="price" onclick="toggleSeries('price')">
                                <span style="color: #666; font-weight: bold;">â”â”</span> <span>æ”¶ç›¤åƒ¹</span>
                            </div>
                            <div class="legend-item" data-series="shortMA" onclick="toggleSeries('shortMA')">
                                <span style="color: #ff9800; font-weight: bold;">â”â”</span> <span>çŸ­æœŸå‡ç·š</span>
                            </div>
                            <div class="legend-item" data-series="longMA" onclick="toggleSeries('longMA')">
                                <span style="color: #7c4dff; font-weight: bold;">â”â”</span> <span>é•·æœŸå‡ç·š</span>
                            </div>
                            <div class="legend-item" data-series="buy" onclick="toggleSeries('buy')">
                                <span style="color: #4caf50;">â–²</span> <span>é»ƒé‡‘äº¤å‰</span>
                            </div>
                            <div class="legend-item" data-series="sell" onclick="toggleSeries('sell')">
                                <span style="color: #f44336;">â–¼</span> <span>æ­»äº¡äº¤å‰</span>
                            </div>
                            <div class="legend-item" data-series="end" onclick="toggleSeries('end')">
                                <span style="color: #000000;">â– </span> <span>æœŸæœ«å¹³å€‰</span>
                            </div>
                        </div>
                        <canvas id="strategyChart" class="chart-canvas"></canvas>
                    </div>

                    ${result.trades.length > 0 ? `
                        <h4 style="margin-top: 30px;">ğŸ“‹ äº¤æ˜“æ˜ç´°</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>å‹•ä½œ</th>
                                        <th>åƒ¹æ ¼</th>
                                        <th>è‚¡æ•¸</th>
                                        <th>å‰©é¤˜ç¾é‡‘</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.trades.map(trade => `
                                        <tr>
                                            <td>${trade.date}</td>
                                            <td style="color: ${trade.action === 'è²·å…¥' ? '#4caf50' : (trade.action === 'è³£å‡º' ? '#f44336' : '#000')}; font-weight: bold;">${trade.action}</td>
                                            <td>$${trade.price.toFixed(2)}</td>
                                            <td>${Math.floor(trade.shares)}</td>
                                            <td>$${trade.cashAfter.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p style="text-align:center; padding:20px;">âš ï¸ æ­¤åƒæ•¸çµ„åˆåœ¨è©²æœŸé–“ç„¡ä»»ä½•äº¤æ˜“</p>'}

                    <button class="btn" onclick="returnToResults()" style="margin-top: 20px;">
                        â¬…ï¸ è¿”å›çµæœåˆ—è¡¨
                    </button>
                </div>
            `;

            document.getElementById('results2').innerHTML = html;

            // ç¹ªè£½åœ–è¡¨
            setTimeout(() => {
                chartState.visible = { price: true, shortMA: true, longMA: true, buy: true, sell: true, end: true };
                initChart(chartDates, chartPrices, chartShortMA, chartLongMA, result.trades, "strategyChart");
            }, 100);
        }

        function returnToResults() {
            const stockSymbol = document.getElementById('stockSelect2').value;
            const initialCash = parseFloat(document.getElementById('initialCash2').value);
            displayOptimizationResults(allOptimizationResults, initialCash, stockSymbol);
        }

        function drawChart(dates, prices, shortMA, longMA, trades) {
            const canvas = document.getElementById('strategyChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // è¨­ç½® canvas å¤§å°
            canvas.width = canvas.offsetWidth;
            canvas.height = 400;

            const padding = { top: 30, right: 30, bottom: 60, left: 60 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;

            // æ‰¾å‡ºåƒ¹æ ¼ç¯„åœ
            const allValues = [...prices];
            shortMA.forEach(v => { if (v !== null) allValues.push(v); });
            longMA.forEach(v => { if (v !== null) allValues.push(v); });
            
            const minPrice = Math.min(...allValues) * 0.95;
            const maxPrice = Math.max(...allValues) * 1.05;
            const priceRange = maxPrice - minPrice;

            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½ç¶²æ ¼ç·š
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + chartWidth, y);
                ctx.stroke();

                // Yè»¸æ¨™ç±¤
                const price = maxPrice - (priceRange / 5) * i;
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText('$' + price.toFixed(2), padding.left - 10, y + 4);
            }

            // Xè»¸æ¨™ç±¤ï¼ˆå‹•æ…‹èª¿æ•´å¯†åº¦ï¼‰
            const avgDateLen = dates.reduce((sum, d) => sum + d.length, 0) / dates.length;
            const charW = 5.5; // å¹³å‡å­—ç¬¦å¯¬åº¦
            const labelW = avgDateLen * charW;
            const spacing = labelW * 1.1;
            const maxLabels = Math.max(6, Math.floor(chartWidth / spacing));
            const dateStep = Math.max(1, Math.ceil(dates.length / maxLabels));
            
            for (let i = 0; i < dates.length; i += dateStep) {
                const x = padding.left + (chartWidth / (dates.length - 1)) * i;
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.save();
                ctx.translate(x, canvas.height - padding.bottom + 15);
                ctx.rotate(-Math.PI / 6);
                ctx.fillText(dates[i], 0, 0);
                ctx.restore();
            }

            // ç¹ªè£½ç·šæ¢å‡½æ•¸
            function drawLine(data, color, lineWidth = 2) {
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.beginPath();
                let started = false;
                
                for (let i = 0; i < data.length; i++) {
                    if (data[i] === null) continue;
                    
                    const x = padding.left + (chartWidth / (data.length - 1)) * i;
                    const y = padding.top + chartHeight - ((data[i] - minPrice) / priceRange) * chartHeight;
                    
                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
            }

            // ç¹ªè£½åƒ¹æ ¼ç·šï¼ˆç°è‰²ï¼‰
            drawLine(prices, '#666666', 2);

            // ç¹ªè£½çŸ­æœŸå‡ç·šï¼ˆæ©™è‰²ï¼‰
            drawLine(shortMA, '#ff9800', 2);

            // ç¹ªè£½é•·æœŸå‡ç·šï¼ˆç´«è‰²ï¼‰
            drawLine(longMA, '#7c4dff', 2);

            // ç¹ªè£½äº¤æ˜“ä¿¡è™Ÿ
            trades.forEach(trade => {
                const dateIdx = dates.indexOf(trade.date);
                if (dateIdx === -1) return;

                const x = padding.left + (chartWidth / (dates.length - 1)) * dateIdx;
                const y = padding.top + chartHeight - ((trade.price - minPrice) / priceRange) * chartHeight;

                if (trade.action === 'è²·å…¥') {
                    // ç¶ è‰²å‘ä¸Šä¸‰è§’å½¢
                    ctx.fillStyle = '#4caf50';
                    ctx.beginPath();
                    ctx.moveTo(x, y - 12);
                    ctx.lineTo(x - 8, y + 4);
                    ctx.lineTo(x + 8, y + 4);
                    ctx.closePath();
                    ctx.fill();
                } else if (trade.action === 'è³£å‡º') {
                    // ç´…è‰²å‘ä¸‹ä¸‰è§’å½¢
                    ctx.fillStyle = '#f44336';
                    ctx.beginPath();
                    ctx.moveTo(x, y + 12);
                    ctx.lineTo(x - 8, y - 4);
                    ctx.lineTo(x + 8, y - 4);
                    ctx.closePath();
                    ctx.fill();
                } else if (trade.action === 'æœŸæœ«è³£å‡º') {
                    // é»‘è‰²æ–¹å¡Š
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(x - 6, y - 6, 12, 12);
                }
            });

            // ç¹ªè£½åº§æ¨™è»¸
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, padding.top + chartHeight);
            ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
            ctx.stroke();
        }
        // --- åƒæ•¸å„ªåŒ–æ¨¡å¼æ ¸å¿ƒé‚è¼¯ ---

        function runOptimization() {
            const stockSymbol = document.getElementById('stockSelect2').value;
            const minMA = parseInt(document.getElementById('minMA').value);
            const maxMA = parseInt(document.getElementById('maxMA').value);
            const maType = document.getElementById('maType').value;
            const startDate = document.getElementById('startDate2').value;
            const endDate = document.getElementById('endDate2').value;
            const initialCash = parseFloat(document.getElementById('initialCash2').value);

            if (!csvData2) {
                showError(2, 'è«‹å…ˆä¸Šå‚³ CSV æª”æ¡ˆ');
                return;
            }

            if (!stockSymbol) {
                showError(2, 'è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼');
                return;
            }

            if (minMA >= maxMA) {
                showError(2, 'æœ€å°å‡ç·šå¤©æ•¸å¿…é ˆå°æ–¼æœ€å¤§å‡ç·šå¤©æ•¸');
                return;
            }

            document.getElementById('loading2').classList.add('show');
            document.getElementById('results2').classList.remove('show');

            // ä½¿ç”¨ setTimeout è®“ UI èƒ½é¡¯ç¤ºã€Œè¨ˆç®—ä¸­ã€çš„å‹•ç•«
            setTimeout(() => {
                const data = parseCSVData(csvData2, stockSymbol);
                if (!data) {
                    showError(2, 'ç„¡æ³•è§£æè‚¡ç¥¨è³‡æ–™');
                    document.getElementById('loading2').classList.remove('show');
                    return;
                }

                let startIdx = data.dates.indexOf(startDate);
                let endIdx = data.dates.indexOf(endDate);

                // æ—¥æœŸå®¹éŒ¯è™•ç†
                if (startIdx === -1) {
                    const startObj = new Date(startDate);
                    startIdx = data.dates.findIndex(d => new Date(d) >= startObj);
                }
                if (endIdx === -1) {
                    const endObj = new Date(endDate);
                    for (let i = data.dates.length - 1; i >= 0; i--) {
                        if (new Date(data.dates[i]) <= endObj) {
                            endIdx = i;
                            break;
                        }
                    }
                }

                if (startIdx === -1 || endIdx === -1 || startIdx >= endIdx) {
                    showError(2, 'æ—¥æœŸç¯„åœç„¡æ•ˆæˆ–æ‰¾ä¸åˆ°è³‡æ–™');
                    document.getElementById('loading2').classList.remove('show');
                    return;
                }

                allOptimizationResults = [];

                // å¾€å‰æ“´å±•æ•¸æ“šï¼ˆæŒ‰ç…§ C++ é‚è¼¯ï¼‰
                const maxPeriod = maxMA;
                const extraDays = maxPeriod - 1;
                const dataStartIdx = Math.max(0, startIdx - extraDays);
                const outputStartIdx = startIdx - dataStartIdx;
                const expandedDates = data.dates.slice(dataStartIdx, endIdx + 1);
                const expandedCloses = data.closes.slice(dataStartIdx, endIdx + 1);

                // æ¸¬è©¦æ‰€æœ‰çµ„åˆ (åŒ…æ‹¬çŸ­æœŸ = é•·æœŸ)
                for (let s = minMA; s <= maxMA; s++) {
                    for (let l = minMA; l <= maxMA; l++) {
                        const result = backtest(expandedDates, expandedCloses, s, l, initialCash, outputStartIdx, expandedDates.length - 1, maType, maType);
                        allOptimizationResults.push(result);
                    }
                }

                // æŒ‰ç…§ C++ é‚è¼¯æ’åº
                allOptimizationResults.sort((a, b) => {
                    // æœ€çµ‚è³‡ç”¢å·®ç•°å¤§æ–¼ 0.0001 æ‰ç®—ä¸åŒ
                    if (Math.abs(a.finalValue - b.finalValue) > 0.0001) {
                        return b.finalValue - a.finalValue; // æœ€çµ‚è³‡ç”¢ç”±é«˜åˆ°ä½
                    }
                    // æœ€çµ‚è³‡ç”¢ç›¸åŒæ™‚ï¼Œåƒæ•¸å·®è·å¤§çš„å„ªå…ˆ
                    const diffA = Math.abs(a.longMA - a.shortMA);
                    const diffB = Math.abs(b.longMA - b.shortMA);
                    if (diffA !== diffB) {
                        return diffB - diffA; // åƒæ•¸å·®è·å¤§çš„å„ªå…ˆ
                    }
                    // çŸ­æœŸå‡ç·šå°çš„å„ªå…ˆ
                    if (a.shortMA !== b.shortMA) {
                        return a.shortMA - b.shortMA;
                    }
                    // é•·æœŸå‡ç·šå°çš„å„ªå…ˆ
                    return a.longMA - b.longMA;
                });

                displayOptimizationResults(allOptimizationResults, initialCash, stockSymbol);
                document.getElementById('loading2').classList.remove('show');
            }, 100);
        }

        function switchResultView(view) {
            currentView = view;
            const stockSymbol = document.getElementById('stockSelect2').value;
            const initialCash = parseFloat(document.getElementById('initialCash2').value);
            displayOptimizationResults(allOptimizationResults, initialCash, stockSymbol);
        }
    </script>
</body>
</html>