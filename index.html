<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMA é›™å‡ç·šå›æ¸¬ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-upload {
            border: 2px dashed #667eea;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-upload:hover {
            background: #f5f5f5;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            margin-top: 5px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .view-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .view-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .view-tab:hover {
            background: #e0e0e0;
        }

        .view-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š SMA é›™å‡ç·šå›æ¸¬ç³»çµ±</h1>
            <p>æ¸¬è©¦æ‚¨çš„äº¤æ˜“ç­–ç•¥ | åŸºæ–¼ MMM è‚¡ç¥¨æ­·å²è³‡æ–™</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('single')">å–®ä¸€ç­–ç•¥å›æ¸¬</button>
            <button class="tab" onclick="switchTab('optimize')">åƒæ•¸å„ªåŒ–æ¨¡å¼</button>
        </div>

        <div class="content">
            <!-- å–®ä¸€ç­–ç•¥å›æ¸¬ -->
            <div id="single" class="tab-content active">
                <h2>ğŸ¯ å–®ä¸€ç­–ç•¥å›æ¸¬</h2>
                <div class="info-box">
                    è¼¸å…¥çŸ­æœŸèˆ‡é•·æœŸå‡ç·šå¤©æ•¸ï¼Œç³»çµ±å°‡é‡å°é»ƒé‡‘äº¤å‰ï¼ˆè²·å…¥ï¼‰èˆ‡æ­»äº¡äº¤å‰ï¼ˆè³£å‡ºï¼‰çš„å›æ¸¬çµæœã€‚
                </div>

                <div class="form-group">
                    <label>ğŸ“ ä¸Šå‚³ CSV æª”æ¡ˆ</label>
                    <div class="file-upload" onclick="document.getElementById('csvFile1').click()">
                        <input type="file" id="csvFile1" accept=".csv" style="display:none" onchange="handleFileUpload(1)">
                        <p id="fileName1">é»æ“Šä¸Šå‚³æˆ–æ‹–æ”¾ CSV æª”æ¡ˆ</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>é¸æ“‡è‚¡ç¥¨ä»£ç¢¼</label>
                    <select id="stockSelect1">
                        <option value="">è«‹å…ˆä¸Šå‚³ CSV æª”æ¡ˆ</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>çŸ­æœŸå‡ç·šï¼ˆå¤©æ•¸ï¼‰</label>
                        <input type="number" id="shortMA" value="5" min="1">
                    </div>
                    <div class="form-group">
                        <label>é•·æœŸå‡ç·šï¼ˆå¤©æ•¸ï¼‰</label>
                        <input type="number" id="longMA" value="20" min="1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥æœŸ</label>
                        <input type="text" id="startDate1" value="1/2/2023" placeholder="M/D/YYYY">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="text" id="endDate1" value="12/29/2023" placeholder="M/D/YYYY">
                    </div>
                </div>

                <div class="form-group">
                    <label>åˆå§‹è³‡é‡‘ ($)</label>
                    <input type="number" id="initialCash1" value="10000" min="1">
                </div>

                <button class="btn" onclick="runSingleBacktest()">é–‹å§‹å›æ¸¬</button>

                <div class="error" id="error1"></div>
                <div class="loading" id="loading1">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è¨ˆç®—ä¸­...</p>
                </div>
                <div class="results" id="results1"></div>
            </div>

            <!-- åƒæ•¸å„ªåŒ–æ¨¡å¼ -->
            <div id="optimize" class="tab-content">
                <h2>âš™ï¸ åƒæ•¸å„ªåŒ–æ¨¡å¼</h2>
                <div class="info-box">
                    ç³»çµ±å°‡æ¸¬è©¦æ‰€æœ‰å¯èƒ½çš„å‡ç·šçµ„åˆï¼Œæ‰¾å‡ºæœ€ä½³ç­–ç•¥åƒæ•¸ã€‚
                </div>

                <div class="form-group">
                    <label>ğŸ“ ä¸Šå‚³ CSV æª”æ¡ˆ</label>
                    <div class="file-upload" onclick="document.getElementById('csvFile2').click()">
                        <input type="file" id="csvFile2" accept=".csv" style="display:none" onchange="handleFileUpload(2)">
                        <p id="fileName2">é»æ“Šä¸Šå‚³æˆ–æ‹–æ”¾ CSV æª”æ¡ˆ</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>é¸æ“‡è‚¡ç¥¨ä»£ç¢¼</label>
                    <select id="stockSelect2">
                        <option value="">è«‹å…ˆä¸Šå‚³ CSV æª”æ¡ˆ</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>æœ€å°å‡ç·šå¤©æ•¸</label>
                        <input type="number" id="minMA" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§å‡ç·šå¤©æ•¸</label>
                        <input type="number" id="maxMA" value="60" min="1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥æœŸ</label>
                        <input type="text" id="startDate2" value="1/2/2023" placeholder="M/D/YYYY">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="text" id="endDate2" value="12/29/2023" placeholder="M/D/YYYY">
                    </div>
                </div>

                <div class="form-group">
                    <label>åˆå§‹è³‡é‡‘ ($)</label>
                    <input type="number" id="initialCash2" value="10000" min="1">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é¡¯ç¤ºçµæœæ•¸é‡</label>
                        <select id="displayCount">
                            <option value="10">å‰ 10 å</option>
                            <option value="20">å‰ 20 å</option>
                            <option value="30" selected>å‰ 30 å</option>
                            <option value="50">å‰ 50 å</option>
                            <option value="100">å‰ 100 å</option>
                            <option value="custom">è‡ªè¨‚æ•¸é‡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è‡ªè¨‚æ•¸é‡ï¼ˆé¸æ“‡è‡ªè¨‚æ™‚ï¼‰</label>
                        <input type="number" id="customCount" value="30" min="1" disabled>
                    </div>
                </div>

                <button class="btn" onclick="runOptimization()">é–‹å§‹å„ªåŒ–</button>

                <div class="error" id="error2"></div>
                <div class="loading" id="loading2">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æ¸¬è©¦æ‰€æœ‰åƒæ•¸çµ„åˆ...</p>
                </div>
                <div class="results" id="results2"></div>
            </div>
        </div>
    </div>

    <script>
        let csvData1 = null;
        let csvData2 = null;
        let allOptimizationResults = [];
        let currentView = 'top';

        // ç›£è½è‡ªè¨‚æ•¸é‡é¸é …
        document.addEventListener('DOMContentLoaded', function() {
            const displayCountSelect = document.getElementById('displayCount');
            const customCountInput = document.getElementById('customCount');
            
            if (displayCountSelect) {
                displayCountSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customCountInput.disabled = false;
                    } else {
                        customCountInput.disabled = true;
                    }
                });
            }
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function handleFileUpload(mode) {
            const fileInput = document.getElementById(`csvFile${mode}`);
            const file = fileInput.files[0];
            
            if (!file) return;

            document.getElementById(`fileName${mode}`).textContent = `å·²é¸æ“‡ï¼š${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const stockSelect = document.getElementById(`stockSelect${mode}`);
                stockSelect.innerHTML = '<option value="">é¸æ“‡è‚¡ç¥¨ä»£ç¢¼</option>';
                
                headers.slice(1).forEach(header => {
                    if (header) {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        stockSelect.appendChild(option);
                    }
                });

                if (mode === 1) csvData1 = { headers, lines };
                else csvData2 = { headers, lines };
            };
            reader.readAsText(file);
        }

        function parseCSVData(csvData, stockSymbol) {
            const targetCol = csvData.headers.indexOf(stockSymbol);
            if (targetCol === -1) return null;

            const dates = [];
            const closes = [];

            for (let i = 1; i < csvData.lines.length; i++) {
                const values = csvData.lines[i].split(',');
                if (values.length > targetCol && values[0] && values[targetCol]) {
                    const date = values[0].trim();
                    const close = parseFloat(values[targetCol]);
                    if (date && !isNaN(close) && close > 0) {
                        dates.push(date);
                        closes.push(close);
                    }
                }
            }

            return { dates, closes };
        }

        function computeMA(closes, window) {
            const ma = [];
            if (closes.length < window) return ma;

            let sum = 0;
            for (let i = 0; i < window; i++) {
                sum += closes[i];
            }
            ma.push(sum / window);

            for (let i = window; i < closes.length; i++) {
                sum += closes[i];
                sum -= closes[i - window];
                ma.push(sum / window);
            }
            return ma;
        }

        function backtest(dates, closes, shortMA_window, longMA_window, initialCash, startIdx, endIdx) {
            const shortMA = computeMA(closes, shortMA_window);
            const longMA = computeMA(closes, longMA_window);

            let cash = initialCash;
            let shares = 0;
            const trades = [];
            let tradeCount = 0;

            for (let i = startIdx; i <= endIdx; i++) {
                const shortMAIdx = i - (shortMA_window - 1);
                const longMAIdx = i - (longMA_window - 1);

                if (shortMAIdx < 0 || longMAIdx < 0 || 
                    shortMAIdx >= shortMA.length || longMAIdx >= longMA.length) {
                    continue;
                }

                if (shortMAIdx === 0 || longMAIdx === 0) continue;

                const prevShortMAIdx = shortMAIdx - 1;
                const prevLongMAIdx = longMAIdx - 1;

                const currShortMA = shortMA[shortMAIdx];
                const currLongMA = longMA[longMAIdx];
                const prevShortMA = shortMA[prevShortMAIdx];
                const prevLongMA = longMA[prevLongMAIdx];
                const currPrice = closes[i];

                // é»ƒé‡‘äº¤å‰ï¼šè²·å…¥
                if (prevShortMA <= prevLongMA && currShortMA > currLongMA && shares === 0) {
                    shares = Math.floor(cash / currPrice);
                    const cost = shares * currPrice;
                    cash -= cost;
                    tradeCount++;

                    trades.push({
                        date: dates[i],
                        action: 'è²·å…¥',
                        price: currPrice,
                        shares: shares,
                        cashAfter: cash
                    });
                }
                // æ­»äº¡äº¤å‰ï¼šè³£å‡º
                else if (prevShortMA >= prevLongMA && currShortMA < currLongMA && shares > 0) {
                    const revenue = shares * currPrice;
                    cash += revenue;

                    trades.push({
                        date: dates[i],
                        action: 'è³£å‡º',
                        price: currPrice,
                        shares: shares,
                        cashAfter: cash
                    });

                    shares = 0;
                    tradeCount++;
                }
            }

            // æœ€çµ‚çµç®—
            let finalValue = cash;
            if (shares > 0) {
                finalValue += shares * closes[endIdx];
                trades.push({
                    date: dates[endIdx],
                    action: 'æœŸæœ«è³£å‡º',
                    price: closes[endIdx],
                    shares: shares,
                    cashAfter: finalValue
                });
                tradeCount++;
            }

            const returnRate = ((finalValue - initialCash) / initialCash) * 100;

            return {
                shortMA: shortMA_window,
                longMA: longMA_window,
                finalValue,
                returnRate,
                tradeCount,
                trades
            };
        }

        function showError(mode, message) {
            const errorDiv = document.getElementById(`error${mode}`);
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function runSingleBacktest() {
            const stockSymbol = document.getElementById('stockSelect1').value;
            const shortMA = parseInt(document.getElementById('shortMA').value);
            const longMA = parseInt(document.getElementById('longMA').value);
            const startDate = document.getElementById('startDate1').value;
            const endDate = document.getElementById('endDate1').value;
            const initialCash = parseFloat(document.getElementById('initialCash1').value);

            if (!csvData1) {
                showError(1, 'è«‹å…ˆä¸Šå‚³ CSV æª”æ¡ˆ');
                return;
            }

            if (!stockSymbol) {
                showError(1, 'è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼');
                return;
            }

            document.getElementById('loading1').classList.add('show');
            document.getElementById('results1').classList.remove('show');

            setTimeout(() => {
                const data = parseCSVData(csvData1, stockSymbol);
                if (!data) {
                    showError(1, 'ç„¡æ³•è§£æè‚¡ç¥¨è³‡æ–™');
                    document.getElementById('loading1').classList.remove('show');
                    return;
                }

                const startIdx = data.dates.indexOf(startDate);
                const endIdx = data.dates.indexOf(endDate);

                if (startIdx === -1 || endIdx === -1) {
                    showError(1, 'æ‰¾ä¸åˆ°æŒ‡å®šçš„æ—¥æœŸç¯„åœ');
                    document.getElementById('loading1').classList.remove('show');
                    return;
                }

                const result = backtest(data.dates, data.closes, shortMA, longMA, initialCash, startIdx, endIdx);

                displaySingleResult(result, initialCash, stockSymbol);
                document.getElementById('loading1').classList.remove('show');
            }, 100);
        }

        function displaySingleResult(result, initialCash, stockSymbol) {
            const resultsDiv = document.getElementById('results1');
            
            let html = `
                <div class="result-card">
                    <h3>ğŸ† å›æ¸¬çµæœ - ${stockSymbol}</h3>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">çŸ­æœŸå‡ç·š</div>
                            <div class="stat-value">${result.shortMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">é•·æœŸå‡ç·š</div>
                            <div class="stat-value">${result.longMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åˆå§‹è³‡é‡‘</div>
                            <div class="stat-value">$${initialCash.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æœ€çµ‚è³‡ç”¢</div>
                            <div class="stat-value">$${result.finalValue.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å ±é…¬ç‡</div>
                            <div class="stat-value">${result.returnRate.toFixed(2)}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">äº¤æ˜“æ¬¡æ•¸</div>
                            <div class="stat-value">${result.tradeCount}</div>
                        </div>
                    </div>
                </div>
            `;

            if (result.trades.length > 0) {
                html += `
                    <h3>ğŸ“‹ äº¤æ˜“æ˜ç´°</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å‹•ä½œ</th>
                                    <th>åƒ¹æ ¼</th>
                                    <th>è‚¡æ•¸</th>
                                    <th>å‰©é¤˜ç¾é‡‘</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                result.trades.forEach(trade => {
                    html += `
                        <tr>
                            <td>${trade.date}</td>
                            <td>${trade.action}</td>
                            <td>$${trade.price.toFixed(2)}</td>
                            <td>${Math.floor(trade.shares)}</td>
                            <td>$${trade.cashAfter.toFixed(2)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += '<p style="text-align:center; padding:20px;">âš ï¸ æ­¤åƒæ•¸çµ„åˆåœ¨è©²æœŸé–“ç„¡ä»»ä½•äº¤æ˜“</p>';
            }

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }

        function runOptimization() {
            const stockSymbol = document.getElementById('stockSelect2').value;
            const minMA = parseInt(document.getElementById('minMA').value);
            const maxMA = parseInt(document.getElementById('maxMA').value);
            const startDate = document.getElementById('startDate2').value;
            const endDate = document.getElementById('endDate2').value;
            const initialCash = parseFloat(document.getElementById('initialCash2').value);

            if (!csvData2) {
                showError(2, 'è«‹å…ˆä¸Šå‚³ CSV æª”æ¡ˆ');
                return;
            }

            if (!stockSymbol) {
                showError(2, 'è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼');
                return;
            }

            document.getElementById('loading2').classList.add('show');
            document.getElementById('results2').classList.remove('show');

            setTimeout(() => {
                const data = parseCSVData(csvData2, stockSymbol);
                if (!data) {
                    showError(2, 'ç„¡æ³•è§£æè‚¡ç¥¨è³‡æ–™');
                    document.getElementById('loading2').classList.remove('show');
                    return;
                }

                const startIdx = data.dates.indexOf(startDate);
                const endIdx = data.dates.indexOf(endDate);

                if (startIdx === -1 || endIdx === -1) {
                    showError(2, 'æ‰¾ä¸åˆ°æŒ‡å®šçš„æ—¥æœŸç¯„åœ');
                    document.getElementById('loading2').classList.remove('show');
                    return;
                }

                const results = [];
                for (let shortMA = minMA; shortMA <= maxMA; shortMA++) {
                    for (let longMA = minMA; longMA <= maxMA; longMA++) {
                        const result = backtest(data.dates, data.closes, shortMA, longMA, initialCash, startIdx, endIdx);
                        results.push(result);
                    }
                }

                results.sort((a, b) => {
                    if (Math.abs(a.finalValue - b.finalValue) > 0.0001) {
                        return b.finalValue - a.finalValue;
                    }
                    const diffA = Math.abs(a.longMA - a.shortMA);
                    const diffB = Math.abs(b.longMA - b.shortMA);
                    if (diffA !== diffB) return diffB - diffA;
                    if (a.shortMA !== b.shortMA) return a.shortMA - b.shortMA;
                    return a.longMA - b.longMA;
                });

                displayOptimizationResults(results, initialCash, stockSymbol);
                allOptimizationResults = results;
                document.getElementById('loading2').classList.remove('show');
            }, 100);
        }

        function switchResultView(view) {
            currentView = view;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡æ–°é¡¯ç¤ºçµæœ
            const stockSymbol = document.getElementById('stockSelect2').value;
            const initialCash = parseFloat(document.getElementById('initialCash2').value);
            displayOptimizationResults(allOptimizationResults, initialCash, stockSymbol);
        }

        function displayOptimizationResults(results, initialCash, stockSymbol) {
            const resultsDiv = document.getElementById('results2');
            const best = results[0];
            const worst = results[results.length - 1];
            
            // å–å¾—é¡¯ç¤ºæ•¸é‡
            const displayCountSelect = document.getElementById('displayCount').value;
            let displayCount;
            if (displayCountSelect === 'custom') {
                displayCount = parseInt(document.getElementById('customCount').value);
            } else {
                displayCount = parseInt(displayCountSelect);
            }
            displayCount = Math.min(displayCount, results.length);
            
            let html = `
                <div class="result-card">
                    <h3>ğŸ† æœ€ä½³ç­–ç•¥ - ${stockSymbol}</h3>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">çŸ­æœŸå‡ç·š</div>
                            <div class="stat-value">${best.shortMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">é•·æœŸå‡ç·š</div>
                            <div class="stat-value">${best.longMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åˆå§‹è³‡é‡‘</div>
                            <div class="stat-value">${initialCash.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æœ€çµ‚è³‡ç”¢</div>
                            <div class="stat-value">${best.finalValue.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å ±é…¬ç‡</div>
                            <div class="stat-value">${best.returnRate.toFixed(2)}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">äº¤æ˜“æ¬¡æ•¸</div>
                            <div class="stat-value">${best.tradeCount}</div>
                        </div>
                    </div>
                </div>

                <div class="result-card" style="background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);">
                    <h3>ğŸ’” æœ€å·®ç­–ç•¥ - ${stockSymbol}</h3>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">çŸ­æœŸå‡ç·š</div>
                            <div class="stat-value">${worst.shortMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">é•·æœŸå‡ç·š</div>
                            <div class="stat-value">${worst.longMA} å¤©</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">åˆå§‹è³‡é‡‘</div>
                            <div class="stat-value">${initialCash.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">æœ€çµ‚è³‡ç”¢</div>
                            <div class="stat-value">${worst.finalValue.toFixed(2)}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">å ±é…¬ç‡</div>
                            <div class="stat-value">${worst.returnRate.toFixed(2)}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">äº¤æ˜“æ¬¡æ•¸</div>
                            <div class="stat-value">${worst.tradeCount}</div>
                        </div>
                    </div>
                </div>

                <div class="view-tabs">
                    <button class="view-tab ${currentView === 'top' ? 'active' : ''}" onclick="switchResultView('top')">
                        ğŸ“ˆ å‰ ${displayCount} å
                    </button>
                    <button class="view-tab ${currentView === 'bottom' ? 'active' : ''}" onclick="switchResultView('bottom')">
                        ğŸ“‰ å€’æ•¸ ${displayCount} å
                    </button>
                    <button class="view-tab ${currentView === 'all' ? 'active' : ''}" onclick="switchResultView('all')">
                        ğŸ“‹ å…¨éƒ¨çµæœ (${results.length})
                    </button>
                </div>
            `;

            // æ±ºå®šè¦é¡¯ç¤ºå“ªäº›çµæœ
            let displayResults = [];
            let title = '';
            
            if (currentView === 'top') {
                displayResults = results.slice(0, displayCount);
                title = `ğŸ“Š å‰ ${displayCount} åæœ€ä½³ç­–ç•¥`;
            } else if (currentView === 'bottom') {
                displayResults = results.slice(-displayCount).reverse();
                title = `ğŸ“Š å€’æ•¸ ${displayCount} åç­–ç•¥`;
            } else {
                displayResults = results;
                title = `ğŸ“Š å…¨éƒ¨ç­–ç•¥çµæœ (å…± ${results.length} çµ„)`;
            }

            html += `
                <h3>${title}</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>çŸ­æœŸMA</th>
                                <th>é•·æœŸMA</th>
                                <th>æœ€çµ‚è³‡ç”¢</th>
                                <th>å ±é…¬ç‡</th>
                                <th>äº¤æ˜“æ¬¡æ•¸</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            displayResults.forEach((r, index) => {
                let rank;
                if (currentView === 'bottom') {
                    rank = results.length - displayCount + index + 1;
                } else {
                    rank = results.indexOf(r) + 1;
                }
                
                html += `
                    <tr>
                        <td>${rank}</td>
                        <td>${r.shortMA}</td>
                        <td>${r.longMA}</td>
                        <td>${r.finalValue.toFixed(2)}</td>
                        <td>${r.returnRate.toFixed(2)}%</td>
                        <td>${r.tradeCount}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }
    </script>
</body>
</html>